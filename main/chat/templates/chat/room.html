{% extends "main/base.html" %}

{% block title %}Chat room for "{{ chat_request.offer }}"{% endblock %}

{% block content %}
{% load static %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-4" style="height: 100%; float: left;">
      <form class="d-flex" role="search" style="margin-top: 2%; align-items: center; justify-content: center;">
        <input style="height: 50px;" class="form-control me-2" type="search" placeholder="Buscar" aria-label="Search">
        <button style="height: 50px;" class="btn btn-outline-success" type="submit">Buscar</button>
        {% if user.cuidador %}
        <a href="{% url 'chat:chat_requests_for_caregiver' %}"
          style="height:70px; width: 70px; display: flex; align-items: center; justify-content: center;">
          <img src="{% static 'Images/sobre.png' %}" style="width: 80%; height: 80%; margin-left: 10px;">
        </a>
        {% endif %}
      </form>
      <hr style="border: 1px solid #1B4965;opacity: 0.62;">
      {% if user.cuidador %}
      <ul>
        {% for chat_request in user.cuidador.chat_requests_received.all %}
        {% if chat_request.accepted %}
        <a class="mb-0" style="color: #1B4965; font-weight: bold;" href="/chat/room/{{ chat_request.id }} ">{{chat_request.sender }}</a>
        <p>Oferta: {{ chat_request.offer.title }}</p>
        <hr style="border: 1px solid #1B4965;opacity: 0.62;position: relative;left: -20px;">
        {% endif %}
        {% endfor %}
      </ul>
      {% endif %}

      {% if user.cliente %}
      <ul>
        {% for chat_request in user.cliente.chat_requests_sent.all %}
        {% if chat_request.accepted %}
        <a class="mb-0" style="color: #1B4965; font-weight: bold;" href="/chat/room/{{ chat_request.id }} "> {{chat_request.receiver }}</a>
        <p>Oferta: {{ chat_request.offer.title }}</p>
        <hr style="border: 1px solid #1B4965;opacity: 0.62;position: relative;left: -20px;">
        {% endif %}
        {% endfor %}
      </ul>
      {% endif %}
    </div>
    <div class="col-md-6" style="margin-left: 100px; margin-top: 30px; margin-bottom: 60px;">
      <div class="chat-header" style="background-color: #1B4965; color: white; padding: 10px;">
        {% if user.cuidador %}        
        <h4 class="mb-0">{{ chat_request.sender }}</h4>
        {% endif %}
        {% if user.cliente %}        
        <h4 class="mb-0">{{ chat_request.receiver }}</h4>
        {% endif %}
      </div>
      
      <div class="chat-body" id="chat" style="background-color: rgb(117, 192, 241); height: 400px; overflow-y: auto; padding: 10px;">
      </div>
     
      <div class="chat-footer" id="chat-input" style="background-color: rgb(117, 192, 241); padding: 10px;">
        <div class="input-group" style="margin-top: 10px;">
          <input id="chat-message-input" type="text" class="form-control" placeholder="Escriba su mensaje aqui">
          <div class="input-group-append">
            <button id="chat-message-submit" class="btn btn-primary" type="button">Enviar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block include_js %}
{{ chat_request.id|json_script:"chat-id" }}
{{ request.user.username|json_script:"request-user" }}
{% endblock %}

{% block domready %}
const chatId = JSON.parse(
document.getElementById('chat-id').textContent
);
const requestUser = JSON.parse(
document.getElementById('request-user').textContent
);
const url = 'ws://' + window.location.host +
'/ws/chat/room/' + chatId + '/';
const chatSocket = new WebSocket(url);

let lastMessageDate = ''; // Variable para almacenar la última fecha mostrada

chatSocket.onmessage = function(event) {
const data = JSON.parse(event.data);
const chat = document.getElementById('chat');

const dateOptions = {day: 'numeric', month: 'long', year: 'numeric', hour: 'numeric', minute: 'numeric', hour12: false}; // Cambiado el formato de fecha
const datetime = new Date(data.datetime).toLocaleString('es-ES', dateOptions); // Cambiado a español
const isMe = data.user === requestUser;
const source = isMe ? 'me' : 'other';
const name = isMe ? 'Me' : data.user;

// Modificamos el estilo según si el mensaje es tuyo o no
const messageStyle = isMe ? 'style="background-color: #DFF0D8; border-radius: 8px; padding: 10px; margin-bottom: 10px; display: inline-block; float: right; clear: both; max-width: 70%;"' : 'style="background-color: #ffffff; border-radius: 8px; padding: 10px; margin-bottom: 10px; display: inline-block; float: left; clear: both; max-width: 70%;"';

// Verificamos si la fecha del mensaje es diferente a la última fecha mostrada
if (lastMessageDate !== datetime.split(',')[0]) {
    // Si es diferente, mostramos la fecha
    chat.innerHTML += '<div class="date-marker" style="text-align: center; margin-bottom: 10px;">' + datetime.split(',')[0] + '</div>';
    // Actualizamos la última fecha mostrada
    lastMessageDate = datetime.split(',')[0];
}

chat.innerHTML += '<div class="message ' + source + '" ' + messageStyle + '>' +
  '<strong>' + name + '</strong> ' +
  '<span class="date">' + datetime.split(',')[1] + '</span><br>' +
  data.message + '</div><br>';
chat.scrollTop = chat.scrollHeight;
};

chatSocket.onclose = function(event) {
console.error('Chat socket closed unexpectedly');
};

const input = document.getElementById('chat-message-input');
const submitButton = document.getElementById('chat-message-submit');

submitButton.addEventListener('click', function(event) {
const message = input.value;
if(message) {
// send message in JSON format
chatSocket.send(JSON.stringify({'message': message}));
// clear input
input.value = '';
input.focus();
}
});

input.addEventListener('keypress', function(event) {
if (event.key === 'Enter') {
// cancel the default action, if needed
event.preventDefault();
// trigger click event on button
submitButton.click();
}
});

input.focus();
{% endblock %}
  